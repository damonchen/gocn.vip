<!--
   _   _                      _                 _
  | | | |                    | |               | |
  | |_| | ___  _ __ ___   ___| | __ _ _ __   __| |
  |  _  |/ _ \| '_ ` _ \ / _ \ |/ _` | '_ \ / _` |
  | | | | (_) | | | | | |  __/ | (_| | | | | (_| |
  \_| |_/\___/|_| |_| |_|\___|_|\__,_|_| |_|\__,_|
  ------------------------------------------------
                          https://gethomeland.com

  - Ruby:  2.6.5-p114
  - Rails: 6.0.2.1
  - Homeland: 3.3.0
-->
<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>在 Go 中转向领域驱动设计 · GopherChina</title>
  <meta name="apple-mobile-web-app-capable" content="no">
  <meta content='True' name='HandheldFriendly' />
  <link rel="alternate" type="application/rss+xml" title="订阅最新帖" href="https://gocn.vip/topics/feed" />
  <link rel="stylesheet" media="screen" href="/assets/front-63d390ab2ab1f90563a309a2c6b335e72140ccad53db766b199ae3ede1df2534.css" data-turbolinks-track="reload" />
  
  
  <meta name="action-cable-url" content="/cable" />
  <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="nY940wc8rmzG9PG7m51qV3X/z9nPf46/qg6ErdyF/4IKXm577PiA2AO9eti/PTHP7I2cKz64a19IWJQro+ghQg==" />
  <link rel="shortcut icon" type="image/png" href="/uploads/favicon.ico"/>
<link rel="apple-touch-icon" sizes="180x180" href="/uploads/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon-16x16.png">
<meta name="keywords" content="GopherChina,Go,Golang,Go语言,Go论坛,Go下载,原创分享,Go图书,开源项目">
<meta name="description" content="GopherChina专注于为 Go语言开发者的技术提升，用户数量、活跃度和内容热度均居国内首位。及时推送官方最新资讯、精选优质语言学习文档、传递一手深工程实践经验，并且会定期举办线下meetup、峰会、培训及赛事，旨在打造全方位权威的 Go 社区。">

  <script src="/assets/app-6c6671b9d1c9418af193d414c1697d346f27a0ba7ab4a510ac051d1647e48087.js" data-turbolinks-track="reload"></script>
  
</head>
<body class="page-topics" data-controller-name="topics">
  <div class="header navbar navbar-expand flex-md-row bd-navbar">
    <div class="container d-sm-flex">
      <div class="navbar-header d-none d-md-flex" id="navbar-header" data-turbolinks-permanent>
        <a href="/" class="navbar-brand"><b><img src="/uploads/logo.png" height="30px"></b></a>
      </div>
      <div class="navbar-nav-scroll">
              <div class="navbar-topic-title">
        <a href="#" class="topic-title pull-left" title="在 Go 中转向领域驱动设计" data-type="top">
          <h1><span class="node">译文</span> <span class="title">在 Go 中转向领域驱动设计</span></h1>
        </a>
      </div>

        <ul id="main-nav-menu" class="navbar-nav d-flex">
  <li class="nav-item"><a class="nav-link active" href="/topics">社区</a></li><li class="nav-item"><a class="nav-link" href="/jobs">招聘</a></li><li class="nav-item"><a class="nav-link" href="/wiki">Wiki</a></li><li class="nav-item"><a class="nav-link" href="/sites">酷站</a></li>
  <ul id="main-nav-menu" class="navbar-nav d-flex">
<li class="nav-item"><a class="nav-link" href="/teams">组织</a></li>
<li class="nav-item"><a class="nav-link" href="https://golang.google.cn/dl/" target="blank">下载</a></li>
<!--<li class="nav-item"><a class="nav-link" href="/wiki/training">培训</a></li>-->
<li class="nav-item"><a class="nav-link" href="/wiki/goproxy">Go Proxy镜像</a></li>
</ul>
</ul>

      </div>
      <div class="ml-auto d-md-flex">
        <form class="navbar-form d-none d-lg-flex mr-2 form-search active" action="/search" method="GET">
          <i class="fa btn-search fa-search"></i>
          <input class="form-control" name="q" type="text" value="" placeholder="搜索本站内容" />
        </form>
        <ul class="nav navbar-nav user-bar align-items-center justify-content-end">

    <li class="nav-item"><a class="nav-link" href="/account/sign_up">注册</a></li>

    <li class="nav-item"><a class="nav-link" href="/account/sign_in">登录</a></li>
</ul>



      </div>
    </div>
  </div>

  

  <div id="main" class="main-container container">
    
    <div class="row">
  <div class="col-md-9">
    <div class="topic-detail card">
      <div class="card-header media clearfix">
  <div class="media-body">
    <h1 class="media-heading">
      <a class="node" href="/topics/node39">译文</a>
      <span class="title">
        在 Go 中转向领域驱动设计
      </span>
      
    </h1>
    <div class="info">
      <a data-author="true" class="user-name" data-name="Kevin" href="/kevin">kevin</a>
      <span class="hidden-mobile">
      </span>
       ·
      <abbr class="timeago" title="2020-02-16T21:57:45+08:00">2020年02月16日</abbr>
      </span>
       ·
      363 次阅读
    </div>
  </div>
  <div class="avatar media-right">
    <a title="kevin (Kevin)" href="/kevin"><img class="media-object avatar-48" src="https://gocn.oss-cn-shanghai.aliyuncs.com/user/avatar/238/32f2aa.jpg?x-oss-process=image/resize,w_96,h_96,m_fill" /></a>
  </div>
</div>

        <div class="label-awesome">
          <i class="fa fa-diamond awesome"></i> 本帖已被设为精华帖！
        </div>
      <div class="card-body markdown markdown-toc">
        
        <p>本文的目的是帮助演示当应用程序随着时间不断推移不断演化时，我们如何利用领域驱动设计帮我们解决可能遇到的问题。为了实现这个目标，我们会通过一个琐碎的项目研究项目是如何随着时间一步步演化的。这不是一个完整的项目，示例代码并不能够直接编译，甚至有些导入以来没有全部列出。这只是一个简单的示例，也就是说，如果出现什么问题，你可以随时与我联系，我们将对问题进行调整或者你的问题及时解答（如果可以的话）。</p>

<p>首先，让我们讨论一下这个项目的背景。想象一下你在工作，老板要求你创建一种通过 GitHub API 对用户进行身份验证的方法。具体上说，你需要利用用户个人访问令牌，查找该用户及其所有组织。 这样，你以后就可以根据他们所属的组织来限制他们的访问。</p>

<p><em>注意：我们这里使用访问令牌来简化示例。</em></p>

<p>这听起来很容易，所以你启动编辑器并实现提供此功能的<code>github</code>包。</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">github</span>

<span class="k">type</span> <span class="n">User</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">ID</span>    <span class="kt">string</span>
  <span class="n">Email</span> <span class="kt">string</span>
  <span class="n">OrgIDs</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">Client</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Key</span>   <span class="kt">string</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Client</span><span class="p">)</span> <span class="n">User</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// 与Github API进行交互，并返回用户。如果他们在一个组织中，返回组织的c.OrgID</span>
<span class="p">}</span>
</code></pre> 
<p><em>注意：这里不是使用真实的 Github API - 这只是一个演示例子。</em></p>

<p>接下来，你需要给<code>github</code>包编写一些中间件，这样你就可以在需要保护的 HTTP handler 中使用这个包。在中间件中，你通过头部中的 basic auth 中获得用户的访问令牌，然后调用 Github 的代码查找用户，检查他们是否是所提供组织的一部分，然后相应地授予权限或拒绝访问。</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">mw</span>

<span class="k">func</span> <span class="n">AuthMiddleware</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">github</span><span class="o">.</span><span class="n">Client</span><span class="p">,</span> <span class="n">reqOrgID</span> <span class="kt">string</span><span class="p">,</span> <span class="n">next</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span><span class="p">)</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">BasicAuth</span><span class="p">()</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
      <span class="n">http</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="err">“</span><span class="n">Unauthorized</span><span class="err">”</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusUnauthorized</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="n">user</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="n">http</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="err">“</span><span class="n">Unauthorized</span><span class="err">”</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusUnauthorized</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="n">permit</span> <span class="o">:=</span> <span class="no">false</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">orgID</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">user</span><span class="o">.</span><span class="n">OrgIDs</span> <span class="p">{</span>
      <span class="k">if</span> <span class="n">orgId</span> <span class="o">==</span> <span class="n">reqOrgID</span> <span class="p">{</span>
        <span class="n">permit</span> <span class="o">=</span> <span class="no">true</span>
        <span class="k">break</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">permit</span> <span class="p">{</span>
      <span class="n">http</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="err">“</span><span class="n">Unauthorized</span><span class="err">”</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusUnauthorized</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="c">// 用户已认证，放他们进来</span>
    <span class="n">next</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre> 
<p>你将这些代码给你的同事看，他们担心缺乏测试。具体的说，没有一种方法能够验证<code>AuthMiddleware</code>能否按照预期工作。“没有问题”，你说，“我们可以使用 interface 保证我们可以方便的测试它！”</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">mw</span>

<span class="k">type</span> <span class="n">UserService</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="n">User</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">github</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">AuthMiddleware</span><span class="p">(</span><span class="n">us</span> <span class="n">UserService</span><span class="p">,</span> <span class="n">reqOrgID</span> <span class="kt">string</span><span class="p">,</span> <span class="n">next</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span><span class="p">)</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">BasicAuth</span><span class="p">()</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
      <span class="n">http</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="err">“</span><span class="n">Unauthorized</span><span class="err">”</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusUnauthorized</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="n">user</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">us</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="n">http</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="err">“</span><span class="n">Unauthorized</span><span class="err">”</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusUnauthorized</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="n">permit</span> <span class="o">:=</span> <span class="no">false</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">orgID</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">user</span><span class="o">.</span><span class="n">OrgIDs</span> <span class="p">{</span>
      <span class="k">if</span> <span class="n">orgId</span> <span class="o">==</span> <span class="n">reqOrgID</span> <span class="p">{</span>
        <span class="n">permit</span> <span class="o">=</span> <span class="no">true</span>
        <span class="k">break</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">permit</span> <span class="p">{</span>
      <span class="n">http</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="err">“</span><span class="n">Unauthorized</span><span class="err">”</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusUnauthorized</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="c">// user is authenticated, let them in</span>
    <span class="n">next</span><span class="o">.</span><span class="n">ServeHTTP</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre> 
<p>现在，你可以使用模拟用户服务测试此代码。</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">mock</span>

<span class="k">type</span> <span class="n">UserService</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">UserFn</span> <span class="k">func</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">github</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">us</span> <span class="o">*</span><span class="n">UserService</span><span class="p">)</span> <span class="n">Authenticate</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">github</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">us</span><span class="o">.</span><span class="n">UserFn</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="p">}</span>
</code></pre> 
<p>创建模拟用户服务有很多方式，但是这个通常需要测试认证正常通过时和认证出现问题时的不同情况。</p>

<p>现在，我们对认证中间件完成测试、发布，生活似乎很愉快。</p>

<p>然后，悲剧发生了。你的 CEO 听说哥斯拉（译者注：哥斯拉毁灭世界？）正在前往旧金山，你的公司无法在未来不确定的情况下继续依赖 Github。如果 Github 整个办公室被摧毁了，没有工程师继续维护该产品怎么办？不，完全不能接受！</p>

<p>幸运的是，还有一家名为 GitLab 的替代公司，似乎做了很多类似 GitHub 的功能，不同的是他们是一个远程工作团队。这意味着哥斯拉永远无法同时消灭所有工程师，对吗？ 🎉</p>

<p>高层似乎认同这个逻辑，他们开始进行迁移。你的工作？你的任务是保证所有认证代码能够在新系统上正常运行！</p>

<p>你花了一些时间查看 GitLab API 文档，好消息是，看起来他们采用了和 Github 类似的策略。GitLab 同样也有个人访问令牌，组织，你只需要重新实现客户端即可。中间件中的代码完全不需要更改，因为你是一个聪明人，你使用了接口！ 😁 现在你只需要创建一个 Github 客户端…</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">gitlab</span>

<span class="k">type</span> <span class="n">User</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">ID</span>    <span class="kt">string</span>
  <span class="n">Email</span> <span class="kt">string</span>
  <span class="n">OrgIDs</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">Client</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Key</span>   <span class="kt">string</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Client</span><span class="p">)</span> <span class="n">User</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// 与Gitlab API交互，返回用户和对应的组织c.OrgID</span>
<span class="p">}</span>
</code></pre> 
<p>现在，把这个功能放入<code>AuthMiddleware</code>中，但是，它却不能正常工作了！</p>

<p>事实证明，即使接口也可能成为耦合的受害者。在这种情况下，这是因为你的接口期望通过<code>User</code>方法返回<code>github.User</code> 。 </p>
 <pre class="highlight go"><code><span class="k">type</span> <span class="n">UserService</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="n">User</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">github</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
                      <span class="o">^^^^^^^^^^^</span>
<span class="p">}</span>
</code></pre> 
<p>怎么办？老板希望明天就要发布了！</p>

<p>现在，你有几种选择：</p>

<ol>
<li>修改中间件，以便<code>UserService</code>接口返回<code>gitlab.User</code>而不是<code>github.User</code>；</li>
<li>创建一个新的专门用于 GitLab 的身份验证中间件。</li>
<li>创建一个通用的用户类型，能够在<code>AuthMiddleware</code>中可以自由切换你的 github 和 gitlab 实现。</li>
</ol>

<p>如果你确信自己的公司以后继续使用 GitLab，则方案 1 就有意义。当然，你需要同时更改用户服务接口和 mock，但是如果是一次性的修改，那么这种方案并不坏。</p>

<p>当然，你并不真正知道你们是否会坚持使用 GitLab。也许哥斯拉会改变它的攻击计划？</p>

<p>如果程序中很多代码都依赖此程序包返回的<code>github.User</code>类型，这个方案也会带来很多麻烦。</p>

<p>方案 2 也是可行的，但是它看起来有点傻傻的。当逻辑不变时，为什么我们需要重写一遍所有的代码和测试？当然，一定有一种接口可以按照你最初的意图实现功能。毕竟，中间件不关心查询的用户，我们只是需要处理其中一些重要信息。</p>

<p>现在，你决定尝试一下方案 3。你创建了一个<code>mw</code>包，定义了一个<code>User</code>类型，然后准备编写一个适配器将其与 Github 和 Gitlab 客户端连接。</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">mw</span>

<span class="k">type</span> <span class="n">User</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">OrgIDs</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">UserService</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="n">User</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre> 
<p>当你编写代码时，你意识到，你实际上并不关心用户 ID 或者电子邮件等等其他信息，因此你完全可以从<code>mw.User</code>中删除这些字段，你只需要制定你关心的字段，这样就可以让代码更容易维护和测试。棒极了！</p>

<p>接下来，你需要创建一个适配器，以便你可以对其进行操作。</p>
 <pre class="highlight go"><code><span class="c">// Package adapter probably isn’t a great package name, but this is a</span>
<span class="c">// demo so deal with it.</span>
<span class="k">package</span> <span class="n">adapter</span>

<span class="k">type</span> <span class="n">GitHubUserService</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Client</span> <span class="o">*</span><span class="n">github</span><span class="o">.</span><span class="n">Client</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">us</span> <span class="o">*</span><span class="n">GitHubUserService</span><span class="p">)</span> <span class="n">User</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">mw</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ghUser</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">us</span><span class="o">.</span><span class="n">Client</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">mw</span><span class="o">.</span><span class="n">User</span><span class="p">{},</span> <span class="n">err</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">mw</span><span class="o">.</span><span class="n">User</span><span class="p">{</span>
    <span class="n">OrgIDs</span><span class="o">:</span> <span class="n">ghUser</span><span class="o">.</span><span class="n">OrgIDs</span><span class="p">,</span>
  <span class="p">},</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">GitLabUserService</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Client</span> <span class="o">*</span><span class="n">gitlab</span><span class="o">.</span><span class="n">Client</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">us</span> <span class="o">*</span><span class="n">GitLabUserservice</span><span class="p">)</span> <span class="n">User</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">mw</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">glUser</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">us</span><span class="o">.</span><span class="n">Client</span><span class="o">.</span><span class="n">User</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">mw</span><span class="o">.</span><span class="n">User</span><span class="p">{},</span> <span class="n">err</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">mw</span><span class="o">.</span><span class="n">User</span><span class="p">{</span>
    <span class="n">OrgIDs</span><span class="o">:</span> <span class="n">glUser</span><span class="o">.</span><span class="n">OrgIDs</span><span class="p">,</span>
  <span class="p">},</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre> 
<p>你也需要更新你的 mock，不过这是一个相当快的修改。</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">mock</span>

<span class="k">type</span> <span class="n">UserService</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">UserFn</span> <span class="k">func</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">mw</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">us</span> <span class="o">*</span><span class="n">UserService</span><span class="p">)</span> <span class="n">Authenticate</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">mw</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">us</span><span class="o">.</span><span class="n">UserFn</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="p">}</span>
</code></pre> 
<p>现在，如果你想将我们的<code>AuthMiddleware</code>与 GitHub 或 GitLab 一起使用，则可以使用如下代码进行操作：</p>
 <pre class="highlight go"><code><span class="k">var</span> <span class="n">myHandler</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span>
<span class="k">var</span> <span class="n">us</span> <span class="n">mw</span><span class="o">.</span><span class="n">UserService</span>
<span class="n">us</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">GitLabUserservice</span><span class="p">{</span>
  <span class="n">Client</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">gitlab</span><span class="o">.</span><span class="n">Client</span><span class="p">{</span>
    <span class="n">Key</span><span class="o">:</span> <span class="err">“</span><span class="n">abc</span><span class="o">-</span><span class="m">123</span><span class="err">”</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span>
<span class="c">// This protects your handler</span>
<span class="n">myHandler</span> <span class="o">=</span> <span class="n">mw</span><span class="o">.</span><span class="n">AuthMiddleware</span><span class="p">(</span><span class="n">us</span><span class="p">,</span> <span class="err">“</span><span class="n">my</span><span class="o">-</span><span class="n">org</span><span class="o">-</span><span class="n">id</span><span class="err">”</span><span class="p">,</span> <span class="n">myHandler</span><span class="p">)</span>
</code></pre> 
<p>我们终于有了一个完全解耦的解决方案。我们可以轻松地在 GitHub 和 GitLab 之间切换，并且当新的源码管理公司出现时，我们也可以很快跟上潮流。</p>
<h2 id="寻找中间方案">寻找中间方案</h2>
<p>在前面的示例中，我们一步步看到了代码从紧密耦合到完全解耦的过程。我们使用<code>adapter</code>包来完成处理这些解耦后的<code>mw</code>和<code>github/gitlab</code>包之间的转换。</p>

<p>这样做的主要好处是我们在最后的时候看到的：我们可以在自由选择使用 GitHub 或 GitLab 认证策略，而不需要修改 handlers 和认证中间件。</p>

<p>尽管这些好处非常棒，但在不考虑成本的情况下探索这些好处是不公平的。 所有这些更改提供了越来越多的代码，如果你回过头去查看<code>gitlab</code>和<code>mw</code>软件包的原始版本，你会发现它们比需要使用 adapter 软件包的最终版本要简单得多。这样也会也可能导致更多的设置项，因为在我们代码的某个地方，我们需要实例化所有这些适配器并将它们连接在一起。</p>

<p>如果沿这条路线继续演进，我们可能会很快发现我们也需要许多不同的 User 类型。例如，我们可能需要在 GitHub（或 GitLab）等服务中将内部用户类型与外部用户 ID 关联。 这可能导致在我们的数据库包中定义一个<code>ExternalUser</code> ，然后编写一个适配器将<code>github.User</code>转换为这种类型，以便我们的数据库代码与我们正在使用的服务解耦。</p>

<p>I actually tried doing this on one project with my HTTP handlers just to see how it turned out. Specifically, I isolated every endpoint in my web application to its own package with no external dependencies specific to my web application and ended up with packages like this:
实际上，为了证明这个结果，我在一个项目上的 HTTP 处理程序上进行过尝试。具体来说，我将 Web 应用程序中的每个端点隔离到其自己的程序包中，而没有特定于 Web 应用程序的外部依赖关系，最终得到了像这样的程序包：</p>
 <pre class="highlight go"><code><span class="c">// Package enroll provides HTTP handlers for enrolling a user into a new</span>
<span class="c">// course.</span>
<span class="c">// This package is entirely for demonstrative purposes and hasn’t been tested,</span>
<span class="c">// but if you do see obvious bugs feel free to let me know and I’ll address</span>
<span class="c">// them.</span>
<span class="k">package</span> <span class="n">enroll</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="err">“</span><span class="n">io</span><span class="err">”</span>
    <span class="err">“</span><span class="n">net</span><span class="o">/</span><span class="n">http</span><span class="err">”</span>

    <span class="err">“</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">gorilla</span><span class="o">/</span><span class="n">schema</span><span class="err">”</span>
<span class="p">)</span>

<span class="c">// Data defines the data that will be provided to the HTML template when it is</span>
<span class="c">// rendered.</span>
<span class="k">type</span> <span class="n">Data</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Form</span>    <span class="n">Form</span>
  <span class="c">// Map of form fields with errors and their error message</span>
  <span class="n">Errors</span>  <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>

  <span class="n">User</span>    <span class="n">User</span>
    <span class="n">License</span> <span class="n">License</span>
<span class="p">}</span>

<span class="c">// License is used to show the user more info about what they are enrolling in.</span>
<span class="c">// Eg if they URL query params have a valid key, we might show them:</span>
<span class="c">//</span>
<span class="c">//   “You are about to enroll in Gophercises - FREE using the key `abc-123`”</span>
<span class="c">//                               ^             ^                   ^</span>
<span class="c">//                             Course       Package               Key</span>
<span class="c">//</span>
<span class="k">type</span> <span class="n">License</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Key</span>     <span class="kt">string</span>
  <span class="n">Course</span>  <span class="kt">string</span>
  <span class="n">Package</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="c">// User defines a user that can be enrolled in courses.</span>
<span class="k">type</span> <span class="n">User</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">ID</span> <span class="kt">string</span>
  <span class="c">// Email is used when rendering a navbar with the user’s email address, among</span>
  <span class="c">// other areas of an HTML page.</span>
  <span class="n">Email</span> <span class="kt">string</span>
  <span class="n">Avatar</span> <span class="kt">string</span>
  <span class="c">// …</span>
<span class="p">}</span>

<span class="c">// Form defines all of the HTML form fields. It assumes the Form will be</span>
<span class="c">// rendered using struct tags and a form package I created</span>
<span class="c">// (https://github.com/joncalhoun/form), but it isn’t really mandatory as</span>
<span class="c">// long as the form field names match the `schema` part here.</span>
<span class="k">type</span> <span class="n">Form</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">License</span>  <span class="kt">string</span> <span class="s">`form:"name=license;label=License key;footer=You can find this in an email sent over by Gumroad after purchasing a course. Or in the case of Gophercises it will be in an email from me (jon@calhoun.io)." schema:"license"`</span>
<span class="p">}</span>

<span class="c">// Handler provides GET and POST http.Handlers</span>
<span class="k">type</span> <span class="n">Handler</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="c">// Interfaces and function types here serve roughly the same purpose. funcs</span>
  <span class="c">// just tend to be easier to write adapters for since you don’t need a</span>
  <span class="c">// struct type with a method.</span>
  <span class="n">UserFn</span>    <span class="k">func</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
  <span class="n">LicenseFn</span> <span class="k">func</span><span class="p">(</span><span class="n">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">License</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

  <span class="c">// Interface because this one is the least likely to need an adapter</span>
  <span class="n">Enroller</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="n">Enroll</span><span class="p">(</span><span class="n">userID</span><span class="p">,</span> <span class="n">licenseKey</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
  <span class="p">}</span>

  <span class="c">// Typically satisfied with an HTML template</span>
  <span class="n">Executor</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="n">Execute</span><span class="p">(</span><span class="n">wr</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span><span class="p">,</span> <span class="n">data</span> <span class="k">interface</span><span class="p">{})</span> <span class="kt">error</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c">// Get handles rendering the Form for a user to enroll in a new course.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span><span class="n">Handler</span><span class="p">)</span> <span class="n">Get</span><span class="p">()</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">user</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">h</span><span class="o">.</span><span class="n">UserFn</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="c">// redirect or render an error</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">var</span> <span class="n">data</span> <span class="n">Data</span>
    <span class="n">data</span><span class="o">.</span><span class="n">User</span> <span class="o">=</span> <span class="n">user</span>

    <span class="k">var</span> <span class="n">form</span> <span class="n">Form</span>
    <span class="n">err</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">ParseForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="c">// maybe log this? We can still render</span>
    <span class="p">}</span>
    <span class="n">dec</span> <span class="o">:=</span> <span class="n">schema</span><span class="o">.</span><span class="n">NewDecoder</span><span class="p">()</span>
    <span class="n">dec</span><span class="o">.</span><span class="n">IgnoreUnknownKeys</span><span class="p">(</span><span class="no">true</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">form</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">Form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="c">// maybe log this? We can still render</span>
    <span class="p">}</span>
    <span class="n">data</span><span class="o">.</span><span class="n">Form</span> <span class="o">=</span> <span class="n">form</span>

    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">License</span> <span class="o">!=</span> <span class="err">“”</span> <span class="p">{</span>
      <span class="n">lic</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">h</span><span class="o">.</span><span class="n">LicenseFn</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">License</span><span class="p">)</span>
      <span class="n">data</span><span class="o">.</span><span class="n">License</span> <span class="o">=</span> <span class="n">lic</span>
      <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">data</span><span class="o">.</span><span class="n">Errors</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
          <span class="err">“</span><span class="n">license</span><span class="err">”</span><span class="o">:</span> <span class="err">“</span><span class="n">is</span> <span class="n">not</span> <span class="n">valid</span><span class="err">”</span><span class="p">,</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">h</span><span class="o">.</span><span class="n">Executor</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c">// Post handles processing the form and enrolling a user.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span><span class="n">Handler</span><span class="p">)</span> <span class="n">Post</span><span class="p">()</span> <span class="n">http</span><span class="o">.</span><span class="n">HandlerFunc</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">user</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">h</span><span class="o">.</span><span class="n">UserFn</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="c">// redirect or render an error</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">var</span> <span class="n">data</span> <span class="n">Data</span>
    <span class="n">data</span><span class="o">.</span><span class="n">User</span> <span class="o">=</span> <span class="n">user</span>

    <span class="k">var</span> <span class="n">form</span> <span class="n">Form</span>
    <span class="n">err</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">ParseForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="c">// maybe log this? We can still render</span>
    <span class="p">}</span>
    <span class="n">dec</span> <span class="o">:=</span> <span class="n">schema</span><span class="o">.</span><span class="n">NewDecoder</span><span class="p">()</span>
    <span class="n">dec</span><span class="o">.</span><span class="n">IgnoreUnknownKeys</span><span class="p">(</span><span class="no">true</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">form</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">Form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="c">// maybe log this? We can still render</span>
    <span class="p">}</span>
    <span class="n">data</span><span class="o">.</span><span class="n">Form</span> <span class="o">=</span> <span class="n">form</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Enroller</span><span class="o">.</span><span class="n">Enroll</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">License</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="n">data</span><span class="o">.</span><span class="n">Errors</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
        <span class="err">“</span><span class="n">license</span><span class="err">”</span><span class="o">:</span> <span class="err">“</span><span class="n">is</span> <span class="n">not</span> <span class="n">valid</span><span class="err">”</span><span class="p">,</span>
      <span class="p">}</span>
      <span class="c">// Re-render the form</span>
      <span class="n">h</span><span class="o">.</span><span class="n">View</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="n">http</span><span class="o">.</span><span class="n">Redirect</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="err">“</span><span class="o">/</span><span class="n">courses</span><span class="err">”</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusFound</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre> 
<p>从理论上讲，这个想法听起来很酷。 现在，我可以单独定义所有 HTTP 处理程序，不必担心应用程序的其余部分的影响。 每个包都可以轻松测试，当我编写这些独立的作品时，我发现自己的工作效率非常高。 我甚至有一个名为<code>Executor</code>的接口，谁不想在他们的代码中使用自定义的执行器？！</p>

<p>在实践中，这个想法对我的特定用例而言太糟糕了。是的，这种方法确实有好处，但是它们并没有超过编写所有这些代码的成本。 在创建<code>enroll</code>和类似软件包的内部组件时，我的工作效率很高，但是我花了很多时间编写适配器并将各个部分连接在一起，这使我的整体生产率下降了。 我找不到一种无需编写自定义<code>UserFn</code> ， <code>LicenseFn</code>的快速方法就可以将其引入到代码中的方案，而且我发现自己为带有 HTTP 处理程序的每个程序包编写了一堆几乎相同的<code>UserFn</code>变种。</p>

<p>这引出了本节的主题- <strong>是否有办法实现可接受的中间方案？</strong></p>

<p>我喜欢将我的代码与第三方依赖项解耦。我也喜欢编写可测试的代码。但是我不喜欢通过加倍的编码工作来实现这一目标。当然，这里必然有一个中间方案，可以在没有所有额外代码的情况下为我们提供大多数好处，对吗？</p>

<p><strong>是的，是有中间方案的</strong>，找到它的关键不是消除所有耦合，而是有意地选择代码所耦合的内容。</p>

<p>让我们回到<code>github</code>和<code>gitlab</code>包的原始示例。在我们的第一个版本（紧密耦合版本）中，我们有一个<code>mw</code>包所依赖的<code>github.User</code>类型。 它满足使用，并且我们甚至可以围绕它构建接口，但是我们仍然与<code>github</code>包紧密耦合。</p>

<p>在第二个版本（解耦版本）中，我们有一个<code>github.User</code> ，<code>gitlab.User</code>和<code>mw.User</code>。 这使我们能够解耦所有内容，但是我们必须创建将这些解耦的代码连接在一起的适配器。</p>

<p>The middle ground, and the third version we will explore, is to intentionally define a User type that every package is allowed to be tightly coupled to. By doing this, we are intentionally choosing where that coupling happens and can make that decision in a way that still makes it easy to test, swap implementations, and do everything else we desire from decoupled code.
我们即将探索的第三种中间方案，是有意允许定义每个包紧密耦合的<code>User</code>类型。通过这种操作，我们刻意选择发生耦合的位置，并且保证易于测试、方便实现交换和易于其他为解耦代码实现的一切方式。</p>

<p>首先是我们的<code>User</code>类型。 这将在<code>domain</code>包中创建，我们应用中的任何其他包都可以导入。</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">domain</span>

<span class="k">type</span> <span class="n">User</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">ID</span>    <span class="kt">string</span>
  <span class="n">Email</span> <span class="kt">string</span>
  <span class="n">OrgIDs</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>
</code></pre> 
<p>接下来，我们将重写<code>github</code>和<code>gitlab</code>软件包以利用此<code>domain.User</code>类型。 这些基本相同，因为我去除了所有的真实逻辑，只展示其中一个。</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">gitlab</span> <span class="c">// github is the same basically</span>

<span class="k">type</span> <span class="n">Client</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Key</span>   <span class="kt">string</span>
<span class="p">}</span>

<span class="c">// Note the return type is domain.User here - this code is now coupled to our</span>
<span class="c">// domain.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Client</span><span class="p">)</span> <span class="n">User</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// … interact with the gitlab API, and return a user if they are in an org with the c.OrgID</span>
<span class="p">}</span>
</code></pre> 
<p>最后，我们有了<code>mw</code>软件包。</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">mw</span>

<span class="k">type</span> <span class="n">UserService</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="n">User</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">AuthMiddleware</span><span class="p">(</span><span class="n">us</span> <span class="n">UserService</span><span class="p">,</span> <span class="n">reqOrgID</span> <span class="kt">string</span><span class="p">,</span> <span class="n">next</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span><span class="p">)</span> <span class="n">http</span><span class="o">.</span><span class="n">Handler</span> <span class="p">{</span>
  <span class="c">// unchanged</span>
<span class="p">}</span>
</code></pre> 
<p>我们甚至可以使用此编写一个模拟包。</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">mock</span>

<span class="k">type</span> <span class="n">UserService</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">UserFn</span> <span class="k">func</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">us</span> <span class="o">*</span><span class="n">UserService</span><span class="p">)</span> <span class="n">Authenticate</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">us</span><span class="o">.</span><span class="n">UserFn</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="p">}</span>
</code></pre> <h2 id="领域驱动设计">领域驱动设计</h2>
<p>到目前为止，我一直努力避免使用任何令人困惑的术语，因为我发现它们通常会使问题变得复杂而不是简化它们。如果你不相信我，请尝试阅读有关域驱动设计（DDD）的任何文章，书籍或其他资源。他们几乎总是使你在代码中实际实现想法带来更多的疑问和更少的明确答案。</p>

<p>我不是在说明 DDD 没有用，也不是在建议你不要读那些书。我的意思是，我的很多（大多数）读者在这里是为了寻求有关如何改进其代码的更实用建议，而不是讨论软件开发理论。</p>

<p>从实际的执行角度来看，领域驱动设计的主要好处是编写可以随时间变化而变化的软件。我发现在 Go 中实现此目标的最佳方法是清楚地定义你的领域类型，然后编写依赖于这些类型的实现。这仍然会导致代码耦合，但是由于你的领域与问题紧密相关，因此你解决这种耦合并不困难。实际上，我经常发现，需要对领域模型进行清晰的定义是有启发性的，而不是麻烦的。</p>

<p><em>注意：定义具体领域类型并将代码耦合到它们的想法并不是独创的或新颖的。本·约翰逊在<a href="https://medium.com/@benbjohnson/standard-package-layout-7cdbc8391fc1" rel="nofollow" target="_blank" title="">2016 年撰写的</a> 这篇文章，对于任何新入门的 Gopher 来说仍然是非常有价值的文章。</em></p>

<p>回到前面的示例，我们看到在<code>domain</code>包中定义了我们的领域 ：</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">domain</span>

<span class="k">type</span> <span class="n">User</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">ID</span>    <span class="kt">string</span>
  <span class="n">Email</span> <span class="kt">string</span>
  <span class="n">OrgIDs</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>
</code></pre> 
<p>再进一步，我们甚至可以开始定义基本的构建块，而我们的其余应用可以实现或者在不与实现细节耦合的情况下使用。 例如我们的 UserService ：</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">domain</span>

<span class="k">type</span> <span class="n">User</span> <span class="k">struct</span> <span class="p">{</span> <span class="err">…</span> <span class="p">}</span>

<span class="k">type</span> <span class="n">UserService</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="n">User</span><span class="p">(</span><span class="n">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre> 
<p>这是由<code>github</code>和<code>gitlab</code>包实现的接口，并在<code>mw</code>包中使用。 它也可以被我们代码中的其他软件包所使用，而不用关心它是如何实现的。而且由于它是在领域中定义的，因此我们不必担心每个实现的返回类型都会有所变化-它们都基于一个通用的定义可以构建。</p>

<p>随着应用程序的发展和变化，这种定义通用接口的想法变得更加强大。 例如，假设我们有一个稍微复杂的 UserService ：也许它会处理创建用户，验证用户，通过令牌查找用户，通过密码重置令牌，更改密码等操作。</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">domain</span>

<span class="k">type</span> <span class="n">UserStore</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="n">Create</span><span class="p">(</span><span class="n">NewUser</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">User</span><span class="p">,</span> <span class="n">RememberToken</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="n">Authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">pw</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">User</span><span class="p">,</span> <span class="n">RememberToken</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="n">ByToken</span><span class="p">(</span><span class="n">RememberToken</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="n">ResetToken</span><span class="p">(</span><span class="n">email</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">ResetToken</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="n">UpdatePw</span><span class="p">(</span><span class="n">pw</span> <span class="kt">string</span><span class="p">,</span> <span class="n">tok</span> <span class="n">ResetToken</span><span class="p">)</span> <span class="p">(</span><span class="n">RememberToken</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre> 
<p>我们可能首先使用纯 SQL 代码和本地数据库来实现：</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">sql</span>

<span class="k">type</span> <span class="n">UserStore</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">DB</span> <span class="o">*</span><span class="n">sql</span><span class="o">.</span><span class="n">DB</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">us</span> <span class="o">*</span><span class="n">UserStore</span><span class="p">)</span> <span class="n">Create</span><span class="p">(</span><span class="n">newUser</span> <span class="n">domain</span><span class="o">.</span><span class="n">NewUser</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">domain</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">domain</span><span class="o">.</span><span class="n">RememberToken</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// …</span>
<span class="p">}</span>

<span class="c">// … and more methods</span>
</code></pre> 
<p>即便当我们只有一个应用程序时，但是也许我们会成长为另一个 Google，我们决定一个集中的用户管理系统，这样我们所有单独的应用都可以使用这套系统。</p>

<p>如果我们将代码耦合到 sql 实现，这基本很难实现，但是由于大多数代码都耦合到 domain.UserService 我们可以编写一个新的实现并使用。</p>
 <pre class="highlight go"><code><span class="k">package</span> <span class="n">userapi</span>

<span class="k">type</span> <span class="n">UserStore</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">HTTPClient</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Client</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">us</span> <span class="o">*</span><span class="n">UserStore</span><span class="p">)</span> <span class="n">Create</span><span class="p">(</span><span class="n">newUser</span> <span class="n">domain</span><span class="o">.</span><span class="n">NewUser</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">domain</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">domain</span><span class="o">.</span><span class="n">RememberToken</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// interact with a third party API instead of a local SQL database</span>
<span class="p">}</span>

<span class="c">// …</span>
</code></pre> 
<p>一般而言，耦合到领域而不是特定的实现方式使我们不必担心诸如以下的细节：</p>

<ul>
<li>
<strong>我们正在与微服务或本地数据库进行交互吗？</strong> 无论我们的用户管理系统是本地 SQL 数据库还是微服务，我们都可以在合理的时间内完成代码编写。
<em>**我们是否通过 JSON，GraphQL，gRPC 或其他方式与用户 API 通信？</em>* 尽管我们的实现需要知道如何与用户 API 进行通信，但是无论我们使用哪种特定技术，我们其余的代码都将继续以相同的方式运行。</li>
<li>其他更多…</li>
</ul>

<p>从根本上讲，这就是我认为领域驱动设计的主要好处。这不是花哨的术语，色彩鲜艳的图形，也不是在同事面前炫耀聪明。纯粹是设计能够不断发展以满足不断变化的需求的软件。</p>
<h2 id="为什么我们不从领域驱动设计开始？">为什么我们不从领域驱动设计开始？</h2>
<p>显而易见的后续问题是：“如果它是如此出色，为什么我们不只是从领域驱动设计开始呢？”</p>

<p>任何有使用模型-视图-控制器（MVC）经验的人都会告诉你，它很容易发生紧密耦合。几乎我们所有的应用程序都将需要依赖于我们的模型，而我们只是探讨了这可能会带来问题。那有什么呢？</p>

<p>从公用领域进行构建虽然很有用，但如果滥用，也可能是一场噩梦。领域驱动设计具有相当陡峭的学习曲线：并不是因为这些想法特别难于掌握，而是因为在项目发展到合理规模之前，你很少了解在应用这些想法时哪里出错了。结果是可能要花几年的时间才能真正掌握所有涉及的动态演化。我已经写了很长一段时间的软件了，但我仍然感觉不到我对所有可能出错或变得复杂的方式都拥有完全的了解。</p>

<p>*注意：这是我花这么长时间发布本文的重要原因之一。在很多时候，我仍然对分享保有疑虑，我不觉得自己是这个主题的专家。但是，我最终决定分享，因为我相信其他人可以从我的有限理解中学到东西，并且我相信随着与其他开发人员进行讨论，本文会随着时间的推移而发展和改进。因此，随时欢迎与我进行讨论 <a href="mailto:jon@calhoun.io" title="">-jon@calhoun.io</a> *</p>

<p>MVC 为你提供了组织代码的合理起点。数据库交互在模型层，http 处理程序在控制器层，渲染代码在视图层。这可能会导致紧密耦合，但可以让你快速入门。</p>

<p>与 MVC 不同，领域驱动设计不会为你提供组织代码的合理起点。实际上，从 DDD 开始与从 MVC 开始几乎完全相反：不是直接进入构建控制器并查看模型如何发展，相反，你必须花大量时间预先确定领域应该是什么。这可能包括模拟一些想法并让同事进行审查，讨论什么是正确/不正确的，几个迭代周期，然后才可以投入到编写一些代码中。 你可以在 <a href="https://medium.com/wtf-dial/wtf-dial-domain-model-9655cd523182" rel="nofollow" target="_blank" title="">Ben Johnson 的 WTF Dial 项目</a> 中看到这一点，他在该 <a href="https://medium.com/wtf-dial/wtf-dial-domain-model-9655cd523182" rel="nofollow" target="_blank" title="">项目</a> 中创建了 PR，并与 Peter Bourgon，Egon Elbre 和 Marcus Olsson 讨论了领域相关内容。</p>

<p>这并不是一件坏事，但正确起来也不容易，它需要大量的前期工作。 因此，如果你有一个更大的团队，每个人都需要在某个共同领域上达成共识，然后才能开始开发，那么我通常会发现这种方法最有效。</p>

<p>鉴于我经常在较小的团队中（或由我自己）进行编码，所以我发现，如果我从简单的事情开始，我的项目就会自然发展。也许这是一个 <a href="https://www.calhoun.io/flat-application-structure/" rel="nofollow" target="_blank" title="">平铺结构</a>  ，也许是 <a href="https://www.calhoun.io/using-mvc-to-structure-go-web-applications/" rel="nofollow" target="_blank" title="">一个 mvc 结构</a>  ，或者也许完全是其他东西。 只要我对代码的发展保持开放的态度，我就不会太着迷于那些细节。这使它最终可以采用 DDD 之类的形式，但是不需要我从那里开始。如前所述，对于大型组织（每个人都一起开发同一应用程序）而言，这样做可能会比较困难，因此通常需要进行更多的前期设计讨论。 </p>

<p>在我们的示例应用程序中，我们做了与 “让它不断发展” 的概念非常相似的事情。每一步都是为特定目的而采取的：我们添加了<code>UserService</code>接口，因为我们需要测试身份验证中间件。 当我们开始从 GitHub 迁移到 GitLab 时，我们意识到我们的接口不够用，因此我们探索了其他选择。 围绕这一点，我认为一种让变得有意义 DDD 的方法，而不是猜测<code>User</code>和<code>UserService</code>接口，因为我们有一些实际的实现基础进行验证。</p>

<p>以 DDD 开头的另一个潜在问题是类型定义不足，因为我们经常在拥有具体用例之前就定义它们。例如，我们可能决定对用户进行身份验证如下所示：</p>
 <pre class="highlight go"><code><span class="k">type</span> <span class="n">UserAuthenticator</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="n">Authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">pw</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre> 
<p>但是后来，我们意识到，实际上，每当我们对用户进行身份验证时，我们确实希望返回该用户（或记住的令牌），并且通过预先定义此接口，而之前我们错过了这一细节。现在，我们需要引入第二种方法来检索此信息，或者我们需要更改<code>UserAuthenticator</code>类型并重构实现利用此功能的任何代码。</p>

<p>同样的情况适用于你的模型。在实际实现<code>github</code>和<code>gitlab</code>软件包之前，我们可能会认为，我们在<code>User</code>模型上唯一需要的识别信息是 Email 字段，但是我们稍后可能会在实现这些服务时意识到电子邮件地址可以更改的，而我们还需要 ID 字段用于唯一标识用户。</p>

<p>在使用领域模型之前定义是一项挑战。除非我们已经非常了解我们正在研究的领域，否则我们极不可能知道我们需要做什么和不需要做什么。是的，这意味着我们必须在以后重构代码，但是如果你错误定义了领域，不使用 DDD 会很多比重构整个代码库更容易。 这是为什么我不介意从紧密耦合的代码开始并在以后进行重构的另一个原因。</p>

<p>最后，并非所有代码都需要这种解耦，它并不能总是能够带来好处，并且在某些情况下（例如 DB），我们很少利用这种解耦。</p>

<p>对于不继续研发的项目，你可能不需要花费所有时间来解耦代码。如果代码没有继续研发，那么更改的可能性将大大降低，而为代码做准备而付出的额外努力可能只是浪费了。</p>

<p>此外，解耦并不总是能提供它所承诺的好处，我们也不会总是利用这种解耦的优势。 正如<a href="https://twitter.com/matryer" rel="nofollow" target="_blank" title="">Mat Ryer</a>所指出的那样 ，我们很少会换掉数据库实现。 即使我们确实实现了所有功能的分离，即使我们碰巧只在少数正在迁移数据库的应用程序中，这种迁移通常也需要彻底重新考虑我们与数据存储之间的交互方式。 毕竟，NoSQL 数据库的行为与 SQL 数据库完全不同，要真正利用两者，我们必须编写所使用数据库的特定代码。最终结果是这些抽象并不总是为我们提供我们想要的神奇的 “实现无关” 的结果。</p>

<p>这并不意味着 DDD 不能提供优势，而是意味着我们不应该简单地 <a href="https://en.wikipedia.org/wiki/Drinking_the_Kool-Aid" rel="nofollow" target="_blank" title="">顶礼膜拜</a> 并期待神奇效果。我们需要停下来自我反思。</p>
<h2 id="综上所述">综上所述</h2>
<p>在本文中，我们直接研究了代码紧密耦合时遇到的问题，并探讨了定义领域类型和接口如何帮助改善这种耦合。 我们还讨论了为什么让我们的代码随着时间的推移而发展，而不是从开始进行这种分离的设计的原因。</p>

<p>在本系列的下一篇文章中，我希望展开讲解使用领域驱动设计编写 Go 代码的想法。 具体来说，我想讨论：</p>

<ul>
<li>接口测试如何帮助确保实现可以毫无问题地互换。 </li>
<li>子域如何衍生自不同的上下文。 </li>
<li>使用传统的 DDD 六边形来形象化这一切，以及像第三方库这样的代码如何适配。 </li>
</ul>

<p>我还想强调，本文绝不是硬性规定。这只是我微薄的尝试，试图分享一些帮助我改进 Go 软件的见解和想法。</p>

<p>我也不是第一个在 Go 中讨论或探索 DDD 和设计模式的人。 你应该查看以下内容以获得更全面的理解：</p>

<ul>
<li> <a href="https://github.com/marcusolsson/goddd" rel="nofollow" target="_blank" title="">GoDDD by Marcus Olsen</a> - 这是一个 GitHub 存储库，其中包含文章和演讲，Marcus Olsen 试图将传统的 DDD Java 示例应用程序移植到 Go 中。 </li>
<li>  <a href="https://medium.com/wtf-dial" rel="nofollow" target="_blank" title="">WTF Dial by Ben Johnson</a> - 我在文中链接了 Ben 的 Standard Pacakage Layout 文章； 本系列应用了 Ben 在该文章中讨论的内容。我还建议查看附带的 PR，并仔细阅读评论。 </li>
<li> <a href="https://www.youtube.com/watch?v=oL6JBUk6tj0" rel="nofollow" target="_blank" title="">How Do You Structure Your Go Apps by Kat Zien</a> - 在演讲中，Kat 通过多种方法构建了 Go 应用程序。附带了演讲的代码仓库和幻灯片。</li>
<li>
<a href="https://www.ardanlabs.com/blog/2017/02/design-philosophy-on-packaging.html" rel="nofollow" target="_blank" title="">Design Philosophy On Packaging by Bill Kennedy</a> - 虽然不专门涉及结构化应用程序，但本系列讨论了与结构紧密联系的包设计。 </li>
</ul>

<p><em>转载自<a href="https://www.4async.com/2020/02/2020-02-16-moving-towards-domain-driven-design-in-go/" rel="nofollow" target="_blank" title="">在 Go 中转向领域驱动设计</a></em></p>
        
      </div>
      <div class="card-footer clearfix">
        <div class="opts">
    <a title="赞" data-count="2" data-state="deactive" data-type="Topic" data-id="9779" class="likeable deactive" href="#"><i class='fa fa-heart'></i> <span>2 个赞</span></a>
    
    

  <span class="pull-right opts">

  </span>
</div>

      </div>
    </div>
    
      <div id="replies" class="card" data-last-floor="2">
        <div class="items card-body">
          <div class="reply reply-system" data-id="6859" id="reply1">
  <div id="reply-6859" data-floor="1">
      <a title="kevin (Kevin)" href="/kevin"><img class="media-object avatar-16" src="https://gocn.oss-cn-shanghai.aliyuncs.com/user/avatar/238/32f2aa.jpg?x-oss-process=image/resize,w_32,h_32,m_fill" /></a> <a class="user-name" data-name="Kevin" href="/kevin">kevin</a>
将本帖设为了精华贴

<span class='time'>02月17日 08:07</span>

  </div>
</div>
<div class="reply reply-system" data-id="6864" id="reply2">
  <div id="reply-6864" data-floor="2">
      <a title="kevin (Kevin)" href="/kevin"><img class="media-object avatar-16" src="https://gocn.oss-cn-shanghai.aliyuncs.com/user/avatar/238/32f2aa.jpg?x-oss-process=image/resize,w_32,h_32,m_fill" /></a> <a class="user-name" data-name="Kevin" href="/kevin">kevin</a>
在
<span class='topic'>
  <a title="GoCN 每日新闻 (2020-02-17)" href="/topics/9781">GoCN 每日新闻 (2020-02-17)</a>
</span> 中提及了此贴

<span class='time'>02月17日 10:08</span>

  </div>
</div>

        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <div id="reply" class="form box">
  <div style="padding:20px;" data-turbolinks-action="replace">
    需要 <a class="btn btn-primary" href="/account/sign_in">登录</a> 后方可回复, 如果你还没有账号请点击这里 <a class="btn btn-danger" href="/account/sign_up">注册</a>。
  </div>
</div>

        </div>
      </div>
          <div class="card">
      <div class="card-header">相关话题</div>
      <ul class="list-group list-group-flush">
          <li class="list-group-item"><a href="/topics/1816">go语言如何实现python那样在前一次请求上保留cookies去请求</a></li>
          <li class="list-group-item"><a href="/topics/8519">Golang 中使用 JSON 的小技巧</a></li>
          <li class="list-group-item"><a href="/topics/1721">多文件多参数上传不能获取参数</a></li>
          <li class="list-group-item"><a href="/topics/8648">当go get遇上gitlab</a></li>
          <li class="list-group-item"><a href="/topics/9355">[译]Go如何优雅的处理异常</a></li>
      </ul>
    </div>

  </div>
    <div class="sidebar hidden-mobile col-md-3">
      <div id="topic-sidebar" data-spy="affix" data-offset-bottom="65">
  <div class="card">
    <div class="card-body">
      <a href="#" class="btn btn-default btn-block btn-sm btn-move-page" data-type="top"><i class="fa fa-arrow-up"></i></a>
      <div class="buttons">
        <div class="group likes opts">
          <a title="赞" data-count="2" data-state="deactive" data-type="Topic" data-id="9779" class="likeable deactive" href="#"><i class='fa fa-heart'></i> <span>2 个赞</span></a>
        </div>
        <div class="group">
          <div class="btn-group" role="group">
            
            
          </div>
        </div>
      </div>
      <hr />
      <div class="group">
        <div class='social-share-button' data-title='在 Go 中转向领域驱动设计' data-img=''
data-url='' data-desc='' data-via=''>
<a rel="nofollow " data-site="twitter" class="ssb-icon ssb-twitter" onclick="return SocialShareButton.share(this);" title="分享到 Twitter" href="#"></a>
<a rel="nofollow " data-site="weibo" class="ssb-icon ssb-weibo" onclick="return SocialShareButton.share(this);" title="分享到 新浪微博" href="#"></a>
<a rel="nofollow " data-site="facebook" class="ssb-icon ssb-facebook" onclick="return SocialShareButton.share(this);" title="分享到 Facebook" href="#"></a>
<a rel="nofollow " data-site="wechat" class="ssb-icon ssb-wechat" onclick="return SocialShareButton.share(this);" title="分享到 微信" data-wechat-footer="打开微信，点击底部的 “发现”，&lt;br/&gt; 使用 “扫一扫” 即可将网页分享至朋友圈。" href="#"></a>
</div>
      </div>
      <hr />
      <div class="reply-buttons">
        <div class="total">
          共收到 <b>0</b> 条回复
        </div>
        <a class="btn btn-success" data-remote="true" href="/kevin/reward"><i class='fa fa-qrcode'></i> <span>打赏支持</span></a>
      </div>
      <hr />
      <div class="group opts">

        <div>
        </div>
      </div>
      <a href="#" class="btn btn-default btn-sm btn-block btn-move-page" data-type="bottom"><i class="fa fa-arrow-down"></i></a>
    </div>
  </div>

  <div class="notify-updated">
    <a class="update" href="#"><i class="fa fa-bell-o"></i> <b>有新回复！</b>点击这里立即载入</a>
  </div>
</div>

    </div>
</div>

  </div>

  <footer class="footer" id="footer" data-turbolinks-permanent>
    <div class="container">
      <div class="container" style="text-align: center;">
      <div class="media" data-turbolinks="false">
  <div class="media-left" style="margin-right:20px;">
    <img class="media-object" src="/uploads/logo.png" style="width: 64px;">
  </div>
  
  <div class="media-body">
    <div class="links">
      <a href="/wiki/about">关于</a> / <a href="http://gopherchina.org" target="_blank" title="Gopher China 大会">GopherChina 大会</a> / <a href="https://goproxy.io" target="_blank" title="镜像">Go proxy 镜像</a> / <a href="/users">活跃会员</a> / <a href="/teams">组织</a> / <a href="https://golang.google.cn/doc/" target="_blank">Go 文档</a> / <a href="/wiki/contributors">贡献者</a>
    </div>
    <div class="copyright">
      由众多爱好者共同维护的 GoCN 社区，本站使用 <a href="https://homeland.ruby-china.org" target="_blank">Homeland</a> 构建。
    </div>
<div class="supports" style="margin: 10px 0;">
    <span style="margin-right: 20px">服务器由 <a href="http://www.ucloud.cn/?utm_source=zanzhu&amp;utm_campaign=gocn&amp;utm_medium=display&amp;utm_content=yejiao&amp;ytag=gocn_logo" target="_blank" rel="twipsy" title="" data-original-title="本站服务器由 UCloud 赞助"><img src="//l.ruby-china.com/photo/2016/e1eb47a05578576bf134da65736cc5b4.png" style="height: 20px; margin-top: -2px"></a> 赞助</span>
   <span> 沪ICP备18015863号-3</span>
   </div>
   <div class="links" style="margin-top:8px">
     <span class="socials">
     <a href="http://github.com/gocn" target="_blank" rel="nofollow" title="本站在 GitHub 上面的开源内容"><i class="fa fa-github"></i></a>
     <a href="http://twitter.com/astaxie" target="_blank" rel="nofollow" title="本站的 Twitter 账号"><i class="fa fa-twitter"></i></a>
     <a href="https://weibo.com/u/3211200050" target="_blank" rel="nofollow" title="本站的 Weibo 账号"><i class="fa fa-weibo"></i></a>
     <a href="https://www.youtube.com/channel/UCLiAl_5hNOMQdeN0safxV6Q" target="_blank" rel="nofollow" title="本站在 YouTube 上面的视频内容"><i class="fa fa-youtube"></i></a>
     <a href="/topics/feed" target="_blank" rel="nofollow"><i class="fa fa-rss"></i></a>
     </span>

     <a href="?locale=zh-CN" rel="nofollow" style="margin-left: 20px">简体中文</a> / <a href="?locale=zh-TW" rel="nofollow">正體中文</a> / <a href="?locale=en" rel="nofollow">English</a>
   </div>
  </div>
</div>
    </div>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?928280caf87c86e98e74eefae01ebae4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


    </div>
  </footer>

  <script type="text/javascript" data-turbolinks-eval="false">
    App.root_url = "https://gocn.vip/";
    App.asset_url = "https://gocn.oss-cn-shanghai.aliyuncs.com";
    App.twemoji_url = "https://twemoji.ruby-china.com/2";
    App.locale = "zh-CN";
  </script>
    <script type="text/javascript">
    Topics.topic_id = 9779;
    $(document).ready(function(){
    
    })
  </script>

  <script>
    ga('create', '', 'auto');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
  </script>
  <div class="zoom-overlay"></div>
</body>
</html>
